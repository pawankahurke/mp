# status

| Name                 | production                                                                                                                                                                                         | master                                                                                                                                                                                         | staging                                                                                                                                                                                          |
| -------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| nh_deployment        | No                                                                                                                                                                                                 | [![pipeline status](https://gitlab.nanoheal.com/Nanoheal-Deployment/nh_deployment/badges/master/pipeline.svg)](https://gitlab.nanoheal.com/Nanoheal-Deployment/nh_deployment/-/commits/master) | [![pipeline status](https://gitlab.nanoheal.com/Nanoheal-Deployment/nh_deployment/badges/staging/pipeline.svg)](https://gitlab.nanoheal.com/Nanoheal-Deployment/nh_deployment/-/commits/staging) |
| mportal              | [![pipeline status](https://gitlab.nanoheal.com/sourcecode/mportal/badges/production/pipeline.svg)](https://gitlab.nanoheal.com/sourcecode/mportal/-/commits/production)                           | [![pipeline status](https://gitlab.nanoheal.com/sourcecode/mportal/badges/master/pipeline.svg)](https://gitlab.nanoheal.com/sourcecode/mportal/-/commits/master)                               | [![pipeline status](https://gitlab.nanoheal.com/sourcecode/mportal/badges/staging/pipeline.svg)](https://gitlab.nanoheal.com/sourcecode/mportal/-/commits/staging)                               |
| dataingestor         | [![pipeline status](https://gitlab.nanoheal.com/sourcecode/dataingestor/badges/production/pipeline.svg)](https://gitlab.nanoheal.com/sourcecode/dataingestor/-/commits/production)                 | [![pipeline status](https://gitlab.nanoheal.com/sourcecode/dataingestor/badges/master/pipeline.svg)](https://gitlab.nanoheal.com/sourcecode/dataingestor/-/commits/master)                     | [![pipeline status](https://gitlab.nanoheal.com/sourcecode/dataingestor/badges/staging/pipeline.svg)](https://gitlab.nanoheal.com/sourcecode/dataingestor/-/commits/staging)                     |
| apigateway           | [![pipeline status](https://gitlab.nanoheal.com/sourcecode/apigateway/badges/production/pipeline.svg)](https://gitlab.nanoheal.com/sourcecode/apigateway/-/commits/production)                     | [![pipeline status](https://gitlab.nanoheal.com/sourcecode/apigateway/badges/main/pipeline.svg)](https://gitlab.nanoheal.com/sourcecode/apigateway/-/commits/main)                             | [![pipeline status](https://gitlab.nanoheal.com/sourcecode/apigateway/badges/staging/pipeline.svg)](https://gitlab.nanoheal.com/sourcecode/apigateway/-/commits/staging)                         |
| analyticsapi         | [![pipeline status](https://gitlab.nanoheal.com/sourcecode/analyticsapi/badges/production/pipeline.svg)](https://gitlab.nanoheal.com/sourcecode/analyticsapi/-/commits/production)                 | [![pipeline status](https://gitlab.nanoheal.com/sourcecode/analyticsapi/badges/main/pipeline.svg)](https://gitlab.nanoheal.com/sourcecode/analyticsapi/-/commits/main)                         | [![pipeline status](https://gitlab.nanoheal.com/sourcecode/analyticsapi/badges/staging/pipeline.svg)](https://gitlab.nanoheal.com/sourcecode/analyticsapi/-/commits/staging)                     |
| visualisationservice | [![pipeline status](https://gitlab.nanoheal.com/sourcecode/visualisationservice/badges/production/pipeline.svg)](https://gitlab.nanoheal.com/sourcecode/visualisationservice/-/commits/production) | [![pipeline status](https://gitlab.nanoheal.com/sourcecode/visualisationservice/badges/master/pipeline.svg)](https://gitlab.nanoheal.com/sourcecode/visualisationservice/-/commits/master)     | [![pipeline status](https://gitlab.nanoheal.com/sourcecode/visualisationservice/badges/staging/pipeline.svg)](https://gitlab.nanoheal.com/sourcecode/visualisationservice/-/commits/staging)     |
| pssubscriber         | [![pipeline status](https://gitlab.nanoheal.com/sourcecode/pssubscriber/badges/production/pipeline.svg)](https://gitlab.nanoheal.com/sourcecode/pssubscriber/-/commits/production)                 | [![pipeline status](https://gitlab.nanoheal.com/sourcecode/pssubscriber/badges/main/pipeline.svg)](https://gitlab.nanoheal.com/sourcecode/pssubscriber/-/commits/main)                         | [![pipeline status](https://gitlab.nanoheal.com/sourcecode/pssubscriber/badges/staging/pipeline.svg)](https://gitlab.nanoheal.com/sourcecode/pssubscriber/-/commits/staging)                     |
| pubsubnode           | [![pipeline status](https://gitlab.nanoheal.com/sourcecode/pubsubnode/badges/production/pipeline.svg)](https://gitlab.nanoheal.com/sourcecode/pubsubnode/-/commits/production)                     | [![pipeline status](https://gitlab.nanoheal.com/sourcecode/pubsubnode/badges/main/pipeline.svg)](https://gitlab.nanoheal.com/sourcecode/pubsubnode/-/commits/main)                             | [![pipeline status](https://gitlab.nanoheal.com/sourcecode/pubsubnode/badges/staging/pipeline.svg)](https://gitlab.nanoheal.com/sourcecode/pubsubnode/-/commits/staging)                         |
| ssoservice           | [![pipeline status](https://gitlab.nanoheal.com/sourcecode/ssoservice/badges/production/pipeline.svg)](https://gitlab.nanoheal.com/sourcecode/ssoservice/-/commits/production)                     | [![pipeline status](https://gitlab.nanoheal.com/sourcecode/ssoservice/badges/main/pipeline.svg)](https://gitlab.nanoheal.com/sourcecode/ssoservice/-/commits/main)                             | [![pipeline status](https://gitlab.nanoheal.com/sourcecode/ssoservice/badges/staging/pipeline.svg)](https://gitlab.nanoheal.com/sourcecode/ssoservice/-/commits/staging)                         |
| filestorageservice   | [![pipeline status](https://gitlab.nanoheal.com/sourcecode/filestorageservice/badges/production/pipeline.svg)](https://gitlab.nanoheal.com/sourcecode/filestorageservice/-/commits/production)     | [![pipeline status](https://gitlab.nanoheal.com/sourcecode/filestorageservice/badges/main/pipeline.svg)](https://gitlab.nanoheal.com/sourcecode/filestorageservice/-/commits/main)             | [![pipeline status](https://gitlab.nanoheal.com/sourcecode/filestorageservice/badges/staging/pipeline.svg)](https://gitlab.nanoheal.com/sourcecode/filestorageservice/-/commits/staging)         |
| sql-proxy            | [![pipeline status](https://gitlab.nanoheal.com/sourcecode/sql-proxy/badges/production/pipeline.svg)](https://gitlab.nanoheal.com/sourcecode/sql-proxy/-/commits/production)                       | [![pipeline status](https://gitlab.nanoheal.com/sourcecode/sql-proxy/badges/main/pipeline.svg)](https://gitlab.nanoheal.com/sourcecode/sql-proxy/-/commits/main)                               | [![pipeline status](https://gitlab.nanoheal.com/sourcecode/sql-proxy/badges/staging/pipeline.svg)](https://gitlab.nanoheal.com/sourcecode/sql-proxy/-/commits/staging)                           |

# Management portal dashboard

- [SSO SAML](docs/sso.md)
- [SSO OAuth](docs/sso-OAuth.md)
- [SAML witth AzureAD](docs/sso/saml-azure/saml-azure.md)
- [Deleting Site Manually](docs/DeletingSiteManually.md)
- [DatePicker](docs/DatePicker.md)
- [DYNAMIC GROUPS](docs/DYNAMIC_GROUPS.md)
- [Notification](docs/Notification.md)
- [Notification drill down](docs/Notification_drill_down.md)
- [Patch Management](docs/Patch_Management.md)
- [ServiceNow](docs/ServiceNow.md)
- [SignupFlowNewChanges](docs/SignupFlowNewChanges_07102021.md)
- [SoftwareDistribution - old](docs/SoftwareDistribution.md)
- [SoftwareDistribution - new](docs/SWD.md)
- [USERS](docs/USERS.md)
- [Increase the License Count in V8/V10 server](https://nanoheal.atlassian.net/wiki/spaces/NANOHEAL/pages/55181321/Increase+the+License+Count+in+V8+V10+server)
- [permissions to access](docs/permissions.md)
- [metabase](docs/metabase.md)
- [darts](docs/darts/darts.md)
- [newDartFunction](docs/darts/newDart.md)
- [DartCustomWidget](docs/dartWidgetComponent.md)
- [Cron functions](docs/cron/cron.md)
- [Expunge machine with csv](docs/expungeMachine/expunge.md)
- [Licence checks "Database is corrupted" error](docs/Licence/readme.md)

# RUN localy

Auth in ECR

```
AWS_ACCESS_KEY_ID=xxxxxxxx AWS_SECRET_ACCESS_KEY='xxxxxxxx' aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin 059920143366.dkr.ecr.us-east-1.amazonaws.com
```

```
docker build -f ./Dockerfile.dev.localhost -t mportal .
docker build -f ./Dockerfile.dev74.localhost -t mportal74 .
```

## Run for windows

(Redis will not work)

```
docker run -p 443:443 -v C:\Nanoheal_files\mportal:/var/www/html -e DB_HOST=qa-db.cyq2mv6upiup.us-east-2.rds.amazonaws.com  -e DB_USERNAME=weblog -e REDIS_MEM_PORT=6379 -e REDIS_HOST=127.0.0.1 -e DB_PASSWORD="b6Q4qT17xyfYJS9CJP2019#" -it 4ecdf86f4a20
```

## Run for linux

```
docker run --network=host -v $(pwd):/var/www/html -e DB_HOST=test-pov2.cteizy5r8ivz.eu-west-1.rds.amazonaws.com -e DB_USERNAME=weblog -e DB_PASSWORD="b6Q4qT17xyfYJS9CJP2019#" -e REDIS_PASSWORD=redisPass -it mportal
```

# Env vars

- VISUALISATION_SERVICE_DASH_URL - for example https://pov.nanoheal.com/visualization
- serverProtocol - 'https://' or 'http://'
- DB_HOST
- DB_USERNAME
- DB_PASSWORD
- configServer
- reportingurl
- NHORG_USERNAME
- NHORG_PASSWORD
- NHORG_SERVER
- SENDGRID_API_KEY
- TWILIO_ACCOUNT_SID
- TWILIO_AUTH_TOKEN
- TWILIO_API_SECRET
- MODSECURITY - "on" or "off"
- APP_CUBEJS_ID - ( can be empty ) used in preAggregationsSchema name for multitenancy
- APP_CUBEJS_SCHEMA - ( can be empty ) used in preAggregationsSchema name for multitenancy
- CUBEJS_API_SECRET
- SSO_NONCE_NO_CHECK - If we have SSO_NONCE_NO_CHECK in env then we in test mode, We can allow do not check NONCE to simplify cypress test code
- ACCESS_NHMYSQL - Access to the /nhmysql page (true/false)

SMTP CONFIG
- SMTP_HOST
- SMTP_PORT
- SMTP_USER_LOGIN
- SMTP_USER_PASSWORD

 you can use the DEFAULT_USER_PASSWORD variable to set the default password for the user

# Tests

Run tests in development mode

```
yarn
yarn run cypress open --config-file cypress-empty-db.config.js
yarn run cypress open --config-file cypress-step-2a.config.js
TEST_SERVER_HOST_NAME=cicd.nanoheal.work yarn run cypress open --config-file cypress-step-2b.config.js
yarn run cypress open --config-file cypress-empty-db-darts.config.js
```

Run tests in development mode https://staging.nanoheal.work/

```
TEST_SERVER_HOST_NAME=cicd.nanoheal.work yarn run cypress open --env brunch=empty-db
```

Run tests in console

```
yarn run cypress run --env brunch=master
```

Run tests for ModSecurity

```
./test/mod_security.sh
```

# Static Code Analysis Tools

We use PHPStan as Static Code Analysis Tools

Prepare to local run:

```bash
cd Dashboard/
composer install
sudo mkdir /var/www/html -p
sudo chmod -R 777 /var/www/html
```

Run PHPStan

```bash
cd Dashboard/
vendor/bin/phpstan analyse  -c phpstan.neon
```

.

#
# mp
